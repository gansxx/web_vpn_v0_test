name: Deploy to Production (SSH Direct)

on:
  workflow_dispatch:
    inputs:
      compression:
        description: 'Compression method'
        required: true
        default: 'gzip'
        type: choice
        options:
          - gzip
          - zstd
          - none

env:
  IMAGE_NAME: vpn-web-nextjs
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    name: Build and Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          build-args: |
            NEXT_PUBLIC_API_BASE=${{ secrets.NEXT_PUBLIC_API_BASE }}
            NEXT_PUBLIC_TURNSTILE_SITE_KEY=${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
            NEXT_PUBLIC_DEV_MODE_ENABLED=false
            NEXT_PUBLIC_DISABLE_TURNSTILE=false
            NEXT_PUBLIC_DISABLE_AUTH_MIDDLEWARE=false

      - name: Export Docker image
        run: |
          mkdir -p /tmp/docker-images
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -o /tmp/docker-images/${{ env.IMAGE_NAME }}.tar

      - name: Compress image
        run: |
          cd /tmp/docker-images
          case "${{ github.event.inputs.compression }}" in
            gzip)
              echo "Compressing with gzip..."
              gzip -f ${{ env.IMAGE_NAME }}.tar
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar.gz"
              ;;
            zstd)
              echo "Compressing with zstd..."
              sudo apt-get update && sudo apt-get install -y zstd
              zstd -f --rm ${{ env.IMAGE_NAME }}.tar
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar.zst"
              ;;
            none)
              echo "No compression"
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar"
              ;;
          esac

          # Generate checksum
          sha256sum "$IMAGE_FILE" > "${IMAGE_FILE}.sha256"

          # Save filename for next step
          echo "IMAGE_FILE=$IMAGE_FILE" >> $GITHUB_ENV

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT || 22 }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Upload image to server
        run: |
          # Create remote directory
          ssh -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "mkdir -p /tmp/docker-images"

          # Upload image and checksum
          scp -P ${{ secrets.SSH_PORT || 22 }} \
            /tmp/docker-images/${{ env.IMAGE_FILE }} \
            /tmp/docker-images/${{ env.IMAGE_FILE }}.sha256 \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/docker-images/

      - name: Copy load script to server
        run: |
          scp -P ${{ secrets.SSH_PORT || 22 }} \
            scripts/load-image.sh \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:/tmp/

      - name: Load and deploy image on server
        run: |
          ssh -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "bash /tmp/load-image.sh /tmp/docker-images/${{ env.IMAGE_FILE }}"

      - name: Restart services
        run: |
          ssh -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "cd /root/self_code/web_vpn_v0_test && docker-compose restart nextjs"

      - name: Health check
        run: |
          echo "Waiting for service to start..."
          sleep 10

          # Health check with retry
          for i in {1..5}; do
            if curl -f https://${{ secrets.DOMAIN }}/api/health; then
              echo "✓ Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 5
          done

          echo "✗ Health check failed after 5 attempts"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          ssh -p ${{ secrets.SSH_PORT || 22 }} \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
            "rm -rf /tmp/docker-images /tmp/load-image.sh" || true
