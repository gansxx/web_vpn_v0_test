name: Deploy to Production (SSH Direct)

on:
  workflow_dispatch:
    inputs:
      compression:
        description: 'Compression method'
        required: true
        default: 'gzip'
        type: choice
        options:
          - gzip
          - zstd
          - none

env:
  IMAGE_NAME: vpn-web-nextjs
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    name: Build and Deploy via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          build-args: |
            NEXT_PUBLIC_API_BASE=${{ secrets.NEXT_PUBLIC_API_BASE || 'https://api.superjiasu.top' }}
            NEXT_PUBLIC_TURNSTILE_SITE_KEY=${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
            NEXT_PUBLIC_DEV_MODE_ENABLED=false
            NEXT_PUBLIC_DISABLE_TURNSTILE=true
            NEXT_PUBLIC_DISABLE_AUTH_MIDDLEWARE=false

      - name: Export Docker image
        run: |
          mkdir -p /tmp/docker-images
          docker save ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} -o /tmp/docker-images/${{ env.IMAGE_NAME }}.tar

      - name: Compress image
        run: |
          cd /tmp/docker-images
          case "${{ github.event.inputs.compression }}" in
            gzip)
              echo "Compressing with gzip..."
              gzip -f ${{ env.IMAGE_NAME }}.tar
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar.gz"
              ;;
            zstd)
              echo "Compressing with zstd..."
              sudo apt-get update && sudo apt-get install -y zstd
              zstd -f --rm ${{ env.IMAGE_NAME }}.tar
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar.zst"
              ;;
            none)
              echo "No compression"
              IMAGE_FILE="${{ env.IMAGE_NAME }}.tar"
              ;;
          esac

          # Generate checksum
          sha256sum "$IMAGE_FILE" > "${IMAGE_FILE}.sha256"

          # Save filename for next step
          echo "IMAGE_FILE=$IMAGE_FILE" >> $GITHUB_ENV

      - name: Debug and Clean Secrets
        run: |
          echo "========== Secrets Validation =========="

          # Clean secrets by removing leading/trailing whitespace
          SSH_HOST_CLEAN=$(echo "${{ secrets.SSH_HOST }}" | xargs)
          SSH_USERNAME_CLEAN=$(echo "${{ secrets.SSH_USERNAME }}" | xargs)
          SSH_PORT_CLEAN=$(echo "${{ secrets.SSH_PORT || 22 }}" | xargs)

          # Debug output (masked)
          echo "SSH_HOST length: ${#SSH_HOST_CLEAN}"
          echo "SSH_HOST (first 3 chars): ${SSH_HOST_CLEAN:0:3}***"
          echo "SSH_USERNAME length: ${#SSH_USERNAME_CLEAN}"
          echo "SSH_USERNAME (first char): ${SSH_USERNAME_CLEAN:0:1}***"
          echo "SSH_PORT: $SSH_PORT_CLEAN"

          # Validate
          if [ -z "$SSH_HOST_CLEAN" ]; then
            echo "ERROR: SSH_HOST is empty after cleanup"
            exit 1
          fi
          if [ -z "$SSH_USERNAME_CLEAN" ]; then
            echo "ERROR: SSH_USERNAME is empty after cleanup"
            exit 1
          fi

          # Export cleaned values
          echo "SSH_HOST=$SSH_HOST_CLEAN" >> $GITHUB_ENV
          echo "SSH_USERNAME=$SSH_USERNAME_CLEAN" >> $GITHUB_ENV
          echo "SSH_PORT=$SSH_PORT_CLEAN" >> $GITHUB_ENV

          echo "✓ Secrets validated and cleaned"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "Setting up SSH known_hosts for: $SSH_HOST"
          ssh-keyscan -p $SSH_PORT -H "$SSH_HOST" >> ~/.ssh/known_hosts

          echo "✓ SSH setup complete"

      - name: Upload image to server
        run: |
          # Create remote directory
          echo "Creating directory on: $SSH_USERNAME@$SSH_HOST"
          ssh -p $SSH_PORT \
            "$SSH_USERNAME@$SSH_HOST" \
            "mkdir -p /tmp/docker-images"

          # Upload image and checksum
          echo "Uploading image to: $SSH_USERNAME@$SSH_HOST:/tmp/docker-images/"
          scp -P $SSH_PORT \
            /tmp/docker-images/${{ env.IMAGE_FILE }} \
            /tmp/docker-images/${{ env.IMAGE_FILE }}.sha256 \
            "$SSH_USERNAME@$SSH_HOST:/tmp/docker-images/"
          echo "✓ Image uploaded successfully"

      - name: Copy load script to server
        run: |
          echo "Copying load script to: $SSH_USERNAME@$SSH_HOST:/tmp/"
          scp -P $SSH_PORT \
            scripts/load-image.sh \
            "$SSH_USERNAME@$SSH_HOST:/tmp/"
          echo "✓ Script copied successfully"

      - name: Load and deploy image on server
        run: |
          echo "Loading image on: $SSH_USERNAME@$SSH_HOST"
          ssh -p $SSH_PORT \
            "$SSH_USERNAME@$SSH_HOST" \
            "bash /tmp/load-image.sh /tmp/docker-images/${{ env.IMAGE_FILE }}"
          echo "✓ Image loaded successfully"

      - name: Restart services
        run: |
          echo "Restarting services on: $SSH_USERNAME@$SSH_HOST"

          # Set project directory (use secret or default to /opt/vpn-web)
          PROJECT_DIR="${{ secrets.PROJECT_DIR }}"
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR="/opt/vpn-web"
            echo "⚠ PROJECT_DIR not set in secrets, using default: $PROJECT_DIR"
          fi

          ssh -p $SSH_PORT \
            "$SSH_USERNAME@$SSH_HOST" \
            "cd $PROJECT_DIR && docker-compose restart nextjs"
          echo "✓ Services restarted successfully"

      - name: Health check
        run: |
          echo "Waiting for service to start..."
          sleep 10

          # Health check with retry
          for i in {1..5}; do
            if curl -f https://${{ secrets.DOMAIN }}/api/health; then
              echo "✓ Health check passed"
              exit 0
            fi
            echo "Health check attempt $i failed, retrying..."
            sleep 5
          done

          echo "✗ Health check failed after 5 attempts"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          if [ -n "$SSH_HOST" ] && [ -n "$SSH_USERNAME" ]; then
            ssh -p $SSH_PORT \
              "$SSH_USERNAME@$SSH_HOST" \
              "rm -rf /tmp/docker-images /tmp/load-image.sh" || true
          fi
          echo "✓ Cleanup complete"
