# Turnstile 代理方案对比

## 🆚 Cloudflare Workers vs 阿里云 FC Nginx

详细对比两种代理方案，帮助你选择最适合的解决方案。

---

## 📊 核心对比表

| 维度 | Cloudflare Workers | 阿里云 FC + Nginx |
|------|-------------------|------------------|
| **🌍 网络路径** | Cloudflare 边缘 → Cloudflare 源站 | 国内用户 → FC → 跨境 → Cloudflare |
| **⚡ 延迟** | 超低（<10ms，边缘网络内部） | 较高（100-300ms，需跨境） |
| **💰 免费额度** | 10万次/天 | 无免费额度 |
| **💸 成本/月** | 免费（中小型应用）<br>$5/月（大型应用） | ¥17-50/月（按调用量） |
| **🛠️ 部署复杂度** | ⭐ 简单（5分钟） | ⭐⭐⭐ 复杂（需配置容器） |
| **🔧 运维成本** | 零运维 | 需维护容器镜像和监控 |
| **📈 可靠性** | ⭐⭐⭐⭐⭐ 99.99% SLA | ⭐⭐⭐ 依赖 FC 可用性 |
| **🇨🇳 国内访问** | 🟡 自定义域名稳定<br>❌ workers.dev 不稳定 | ✅ 稳定（FC 在国内） |
| **📊 扩展性** | 自动扩展（无限） | 需手动配置实例规格 |
| **🔍 调试难度** | 🟡 需使用 Wrangler CLI | ✅ 可本地运行容器 |
| **🌐 全球部署** | ✅ 自动全球 300+ 节点 | ❌ 仅国内节点 |
| **🔐 安全性** | ✅ Cloudflare 安全防护 | 🟡 需自行配置 |

---

## 🎯 使用场景推荐

### ✅ 选择 Cloudflare Workers 的情况

| 场景 | 原因 |
|------|------|
| **预算有限** | 免费额度 10万次/天，中小型应用完全够用 |
| **快速上线** | 5分钟部署，无需运维 |
| **全球用户** | 自动全球加速，海外用户体验极佳 |
| **零运维需求** | 自动扩展，无需关心服务器 |
| **开发团队小** | 一个人即可完成部署和维护 |
| **高可用要求** | 99.99% SLA，自动故障转移 |

**典型用户**：
- 初创公司
- 个人项目
- 中小型 SaaS 应用
- 技术团队 < 5 人

---

### ✅ 选择阿里云 FC + Nginx 的情况

| 场景 | 原因 |
|------|------|
| **用户 100% 在国内** | FC 在国内数据中心，访问最稳定 |
| **需要深度定制** | 完全控制 Nginx 配置 |
| **已有阿里云基础设施** | 集成成本低，统一管理 |
| **企业合规要求** | 数据不出境，满足合规需求 |
| **需要本地调试** | 可以本地运行完全相同的容器 |

**典型用户**：
- 企业级应用
- 政府/金融行业（合规要求）
- 已使用阿里云生态
- 需要深度定制

---

## 💰 成本详细对比

### Cloudflare Workers 成本

```
假设：每天 10,000 次 Turnstile 验证

免费版（每天）：
✅ 100,000 次请求
✅ 10ms CPU 时间/请求
→ 成本：$0/月

付费版（超出免费额度）：
$5/月基础费 + 超额费用
→ 10,000 次/天 = 300,000 次/月
→ 成本：$0/月（仍在免费额度内）

大型应用（每天 100,000 次）：
3,000,000 次/月 - 10,000,000 次免费 = -7,000,000
→ 成本：$5/月（仅基础费）
```

### 阿里云 FC 成本

```
假设：每天 10,000 次 Turnstile 验证

调用费用：
10,000 × ¥0.0000017/次 × 30天 = ¥0.51/月

执行时长（假设 100ms/次，512MB 内存）：
10,000 × 100ms × 0.5GB × ¥0.00003360/GB秒 × 30天 = ¥5.04/月

流量费用（假设 50KB/次）：
10,000 × 50KB × 30天 = 14.65GB × ¥0.8/GB = ¥11.72/月

总计：¥0.51 + ¥5.04 + ¥11.72 = ¥17.27/月

大型应用（每天 100,000 次）：
→ 成本：约 ¥172/月
```

**成本对比结论**：
- **中小型应用**：Cloudflare Workers 免费 > FC ¥17/月
- **大型应用**：Cloudflare Workers $5/月 < FC ¥172/月

---

## ⚡ 性能对比

### 延迟测试

| 场景 | Cloudflare Workers | 阿里云 FC |
|------|-------------------|-----------|
| **国内用户 → 加载脚本** | 50-100ms | 20-50ms |
| **国内用户 → 验证请求** | 100-200ms | 150-300ms |
| **海外用户 → 加载脚本** | 10-50ms | 300-500ms |
| **海外用户 → 验证请求** | 50-100ms | 400-600ms |

**关键发现**：
- ✅ **Workers 边缘网络优势**：验证请求在 Cloudflare 内部完成，延迟极低
- ✅ **FC 国内优势**：加载脚本在国内最快（但验证仍需跨境）
- ❌ **FC 海外劣势**：海外用户延迟明显高于 Workers

---

## 🔧 部署复杂度对比

### Cloudflare Workers

```bash
# 步骤 1: 安装 CLI
npm install -g wrangler

# 步骤 2: 登录
wrangler login

# 步骤 3: 部署
wrangler deploy

# 总时间：5 分钟
```

**技能要求**：
- 基础 JavaScript 知识
- 命令行基本操作

---

### 阿里云 FC + Nginx

```bash
# 步骤 1: 创建 Dockerfile
# 步骤 2: 编写 Nginx 配置
# 步骤 3: 构建镜像
docker build -t nginx-turnstile-proxy .

# 步骤 4: 推送到阿里云容器镜像服务
docker tag nginx-turnstile-proxy:latest registry.cn-hangzhou.aliyuncs.com/xxx/nginx-turnstile-proxy:latest
docker push registry.cn-hangzhou.aliyuncs.com/xxx/nginx-turnstile-proxy:latest

# 步骤 5: 创建 FC 函数
# 步骤 6: 配置触发器
# 步骤 7: 测试和调试

# 总时间：30-60 分钟
```

**技能要求**：
- Docker 容器知识
- Nginx 配置经验
- 阿里云 FC 熟悉度
- Linux 系统管理

---

## 🛡️ 可靠性对比

### Cloudflare Workers

```
可用性：99.99% SLA
故障转移：自动
监控：内置 Dashboard
日志：实时日志流
告警：支持 Webhook

单点故障风险：无（全球分布式）
运维负担：零
```

### 阿里云 FC

```
可用性：99.95% SLA
故障转移：需配置
监控：需集成云监控
日志：需配置日志服务
告警：需手动配置

单点故障风险：中（依赖单一区域）
运维负担：中（需定期检查）
```

---

## 📈 扩展性对比

### 并发处理能力

| 维度 | Cloudflare Workers | 阿里云 FC |
|------|-------------------|-----------|
| **并发限制** | 无限（自动扩展） | 需配置实例规格 |
| **突发流量** | 自动处理 | 可能冷启动延迟 |
| **成本增长** | 线性（按使用付费） | 线性（按调用量） |

---

## 🔍 调试与监控对比

### Cloudflare Workers

```bash
# 本地开发
wrangler dev

# 实时日志
wrangler tail

# Dashboard 监控
# - 请求量
# - 错误率
# - P50/P99 延迟
```

**优势**：
- ✅ 开箱即用的监控
- ✅ 实时日志流
- ❌ 本地调试有限

---

### 阿里云 FC

```bash
# 本地开发（完全相同的环境）
docker run -p 9000:9000 nginx-turnstile-proxy

# 查看日志
fc logs -f function-name

# 集成云监控
# - 需手动配置
# - 需集成日志服务
```

**优势**：
- ✅ 完全本地调试
- ✅ 熟悉的 Nginx 配置
- ❌ 监控需手动配置

---

## 🌐 国内访问稳定性

### Cloudflare Workers

```
workers.dev 域名：
❌ 不稳定（可能被墙）

自定义域名：
✅ 稳定（需选择合适的域名）

注意事项：
- 域名需备案（如果使用国内 DNS）
- 避免使用敏感词
- 准备多个备用域名
```

### 阿里云 FC

```
默认域名：
✅ 稳定（.fc.aliyuncs.com）

自定义域名：
✅ 稳定（国内备案域名）

注意事项：
- 必须备案
- 访问速度快
- 适合国内用户
```

**结论**：**国内访问稳定性 FC > Workers（需自定义域名）**

---

## 🎓 技术门槛对比

### Cloudflare Workers

```yaml
入门难度: ⭐⭐ (简单)
所需技能:
  - JavaScript 基础
  - HTTP 协议了解
  - 命令行基本操作

学习曲线:
  - 1 天：理解 Workers 概念
  - 1 天：完成第一个部署
  - 1 周：掌握常见用法
```

### 阿里云 FC + Nginx

```yaml
入门难度: ⭐⭐⭐⭐ (复杂)
所需技能:
  - Docker 容器技术
  - Nginx 配置
  - Linux 系统管理
  - 阿里云服务熟悉度

学习曲线:
  - 3 天：理解 FC 和容器化
  - 1 周：完成第一个部署
  - 1 月：掌握常见问题排查
```

---

## 🎯 最终推荐

### 💡 **大多数情况推荐：Cloudflare Workers**

**理由**：
1. ✅ 免费额度足够中小型应用
2. ✅ 5分钟部署，零运维
3. ✅ 全球加速，海外用户体验好
4. ✅ 99.99% SLA，高可用
5. ✅ 自动扩展，无需担心并发

**适用场景**：
- 个人项目
- 初创公司
- SaaS 应用
- 全球用户分布

---

### 💡 **特殊情况推荐：阿里云 FC**

**理由**：
1. ✅ 国内访问最稳定
2. ✅ 完全控制配置
3. ✅ 满足合规要求

**适用场景**：
- 用户 100% 在国内
- 企业级应用（合规要求）
- 已有阿里云生态
- 需要深度定制

---

## 🚀 混合方案（最佳实践）

```typescript
// lib/turnstile-config.ts
export async function getOptimalProxyUrl(): Promise<string> {
  // 检测用户地理位置
  const isChina = await detectChinaUser();

  if (isChina) {
    // 国内用户：使用 FC 代理
    return 'https://your-fc-domain.cn-hangzhou.fc.aliyuncs.com';
  } else {
    // 海外用户：使用 Workers 代理
    return 'https://turnstile.yourdomain.com';
  }
}
```

**优势**：
- ✅ 国内外用户都有最佳体验
- ✅ 双重保障，互为备份
- ❌ 运维成本增加

---

## 📝 决策清单

选择 Workers 如果你：
- [ ] 预算有限（希望免费或低成本）
- [ ] 需要快速上线（<1天）
- [ ] 技术团队小（<5人）
- [ ] 有海外用户
- [ ] 不想运维服务器

选择 FC 如果你：
- [ ] 用户 100% 在国内
- [ ] 有企业合规要求
- [ ] 已使用阿里云生态
- [ ] 需要深度定制 Nginx
- [ ] 有专业运维团队

---

需要更详细的实现指南？查看：
- [Cloudflare Workers 快速开始](./TURNSTILE_QUICK_START.md)
- [代理逻辑详解](./TURNSTILE_PROXY_GUIDE.md)
